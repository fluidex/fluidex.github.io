<!DOCTYPE html><html lang="zh"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.9a5d2afd2dfd940cbcc7.css" id="gatsby-global-css">code[class*=language-],pre[class*=language-]{color:#e3eaf2;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#3c526d}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#111b27}:not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.3em;white-space:normal;color:#333;background:silver}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8da1b9}.token.punctuation{color:#e3eaf2}.token.delimiter.important,.token.selector .parent,.token.tag,.token.tag .token.punctuation{color:#6cc}.token.attr-name,.token.boolean,.token.boolean.important,.token.constant,.token.number,.token.selector .token.attribute{color:#e6d37a}.token.class-name,.token.key,.token.parameter,.token.property,.token.property-access,.token.variable{color:#6cb8e6}.token.attr-value,.token.color,.token.inserted,.token.selector .token.value,.token.string,.token.string .token.url-link{color:#91d076}.token.builtin,.token.keyword-array,.token.package,.token.regex{color:#f4adf4}.token.function,.token.selector .token.class,.token.selector .token.id{color:#c699e3}.token.atrule .token.rule,.token.combinator,.token.keyword,.token.operator,.token.pseudo-class,.token.pseudo-element,.token.selector,.token.unit{color:#e9ae7e}.token.deleted,.token.important{color:#cd6660}.token.keyword-this,.token.this{color:#6cb8e6}.token.bold,.token.important,.token.keyword-this,.token.this{font-weight:700}.token.delimiter.important{font-weight:inherit}.token.italic{font-style:italic}.token.entity{cursor:help}.language-markdown .token.title,.language-markdown .token.title .token.punctuation{color:#6cb8e6;font-weight:700}.language-markdown .token.blockquote.punctuation{color:#f4adf4}.language-markdown .token.code{color:#6cc}.language-markdown .token.hr.punctuation{color:#6cb8e6}.language-markdown .token.url .token.content{color:#91d076}.language-markdown .token.url-link{color:#e6d37a}.language-markdown .token.list.punctuation{color:#f4adf4}.language-json .token.operator,.language-markdown .token.table-header{color:#e3eaf2}.language-scss .token.variable{color:#6cc}.token.cr:before,.token.lf:before,.token.space:before,.token.tab:not(:empty):before{color:#8da1b9}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button{color:#111b27;background:#6cb8e6}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover{color:#111b27;background:rgba(108,184,230,.8549019607843137);text-decoration:none}div.code-toolbar>.toolbar span,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:#111b27;background:#8da1b9}.line-highlight{background:rgba(60,82,109,.37254901960784315);background:linear-gradient(90deg,rgba(60,82,109,.37254901960784315) 70%,rgba(60,82,109,.3333333333333333))}.line-highlight:before,.line-highlight[data-end]:after{background-color:#8da1b9;color:#111b27;box-shadow:0 1px #3c526d}pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(141,161,185,.09411764705882353)}.line-numbers .line-numbers-rows{border-right:1px solid #0b121b;background:rgba(11,18,27,.47843137254901963)}.line-numbers-rows>span:before{color:rgba(141,161,185,.8549019607843137)}.rainbow-braces .token.punctuation.brace-level-1,.rainbow-braces .token.punctuation.brace-level-5,.rainbow-braces .token.punctuation.brace-level-9{color:#e6d37a}.rainbow-braces .token.punctuation.brace-level-2,.rainbow-braces .token.punctuation.brace-level-6,.rainbow-braces .token.punctuation.brace-level-10{color:#f4adf4}.rainbow-braces .token.punctuation.brace-level-3,.rainbow-braces .token.punctuation.brace-level-7,.rainbow-braces .token.punctuation.brace-level-11{color:#6cb8e6}.rainbow-braces .token.punctuation.brace-level-4,.rainbow-braces .token.punctuation.brace-level-8,.rainbow-braces .token.punctuation.brace-level-12{color:#c699e3}pre.diff-highlight>code .token.deleted:not(.prefix),pre>code.diff-highlight .token.deleted:not(.prefix){background-color:rgba(205,102,96,.12156862745098039)}pre.diff-highlight>code .token.inserted:not(.prefix),pre>code.diff-highlight .token.inserted:not(.prefix){background-color:rgba(145,208,118,.12156862745098039)}.command-line-prompt{border-right:1px solid #0b121b}.command-line-prompt>span:before{color:rgba(141,161,185,.8549019607843137)}</style><meta name="generator" content="Gatsby 3.0.1"/><style data-styled="" data-styled-version="5.2.1">.dWGLst{margin-left:auto;margin-right:auto;max-width:1300px;padding-left:var(--size-700);padding-right:var(--size-700);height:100%;}/*!sc*/
@media screen and (max-width:1000px){.dWGLst{padding-left:var(--size-400);padding-right:var(--size-400);}}/*!sc*/
data-styled.g1[id="container__Container-g6pcgm-0"]{content:"dWGLst,"}/*!sc*/
.hUaVNz{padding-top:var(--size-300);}/*!sc*/
data-styled.g2[id="header__StyledHeader-sc-1344zpp-0"]{content:"hUaVNz,"}/*!sc*/
.kTLBWK{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}/*!sc*/
data-styled.g3[id="header__HeaderWrapper-sc-1344zpp-1"]{content:"kTLBWK,"}/*!sc*/
.ljBqLG a{text-transform:uppercase;-webkit-text-decoration:none;text-decoration:none;font-size:var(--size-400);color:inherit;}/*!sc*/
data-styled.g4[id="header__HeaderTitle-sc-1344zpp-2"]{content:"ljBqLG,"}/*!sc*/
.gMMtgi{position:static;padding:0;background:transparent;-webkit-backdrop-filter:unset;backdrop-filter:unset;}/*!sc*/
data-styled.g5[id="header__StyledNav-sc-1344zpp-3"]{content:"gMMtgi,"}/*!sc*/
.lcjsVP{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:space-around;-webkit-justify-content:space-around;-ms-flex-pack:space-around;justify-content:space-around;padding:0;list-style-type:none;}/*!sc*/
data-styled.g6[id="header__StyledNavList-sc-1344zpp-4"]{content:"lcjsVP,"}/*!sc*/
.estiEP:not(:last-of-type){margin-right:2rem;}/*!sc*/
@media screen and (max-width:700px){.estiEP:not(:last-of-type){margin-right:1rem;}}/*!sc*/
.estiEP a{color:inherit;text-transform:uppercase;font-size:var(--size-300);-webkit-text-decoration:none;text-decoration:none;-webkit-letter-spacing:0.1rem;-moz-letter-spacing:0.1rem;-ms-letter-spacing:0.1rem;letter-spacing:0.1rem;}/*!sc*/
@media screen and (max-width:700px){.estiEP a{font-size:0.7rem;}}/*!sc*/
data-styled.g7[id="header__StyledNavListItem-sc-1344zpp-5"]{content:"estiEP,"}/*!sc*/
.elPAeh{padding:0;list-style:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
data-styled.g8[id="social-links__SocialLinkList-r9vd8i-0"]{content:"elPAeh,"}/*!sc*/
.PkigP{margin-right:var(--size-400);text-transform:uppercase;}/*!sc*/
.PkigP a{color:inherit;font-size:var(--size-300);}/*!sc*/
data-styled.g9[id="social-links__SocialLinkItem-r9vd8i-1"]{content:"PkigP,"}/*!sc*/
.bXLsAg{padding-top:var(--size-300);padding-bottom:var(--size-300);}/*!sc*/
data-styled.g10[id="footer__StyledFooter-sc-1d6x338-0"]{content:"bXLsAg,"}/*!sc*/
.kzqyOn{font-size:var(--size-300);}/*!sc*/
.kzqyOn a{color:inherit;}/*!sc*/
data-styled.g11[id="footer__FooterAttribution-sc-1d6x338-1"]{content:"kzqyOn,"}/*!sc*/
.iWYEYe{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}/*!sc*/
data-styled.g12[id="footer__FooterWrapper-sc-1d6x338-2"]{content:"iWYEYe,"}/*!sc*/
*,*::before,*::after{box-sizing:border-box;}/*!sc*/
body,h1,h2,h3,h4,p,figure,blockquote,dl,dd{margin:0;}/*!sc*/
ul[role='list'],ol[role='list']{list-style:none;}/*!sc*/
html:focus-within{-webkit-scroll-behavior:smooth;-moz-scroll-behavior:smooth;-ms-scroll-behavior:smooth;scroll-behavior:smooth;}/*!sc*/
html{height:-webkit-fill-available;}/*!sc*/
body{min-height:100vh;min-height:-webkit-fill-available;text-rendering:optimizeSpeed;line-height:1.5;}/*!sc*/
a:not([class]){-webkit-text-decoration-skip-ink:auto;text-decoration-skip-ink:auto;}/*!sc*/
img,picture{max-width:100%;display:block;}/*!sc*/
input,button,textarea,select{font:inherit;}/*!sc*/
@media (prefers-reduced-motion:reduce){html:focus-within{-webkit-scroll-behavior:auto;-moz-scroll-behavior:auto;-ms-scroll-behavior:auto;scroll-behavior:auto;}*,*::before,*::after{-webkit-animation-duration:0.01ms !important;animation-duration:0.01ms !important;-webkit-animation-iteration-count:1 !important;animation-iteration-count:1 !important;-webkit-transition-duration:0.01ms !important;transition-duration:0.01ms !important;-webkit-scroll-behavior:auto !important;-moz-scroll-behavior:auto !important;-ms-scroll-behavior:auto !important;scroll-behavior:auto !important;}}/*!sc*/
html{width:100vw;overflow-x:hidden;}/*!sc*/
body::-webkit-scrollbar{width:10px;}/*!sc*/
body::-webkit-scrollbar-thumb{background-color:rgba(55,41,44,.4);}/*!sc*/
body::-webkit-scrollbar-track{background:#aaa;}/*!sc*/
:root{--size-300:0.75rem;--size-400:1rem;--size-500:1.33rem;--size-600:1.77rem;--size-700:2.36rem;--size-800:3.15rem;--size-900:4.2rem;}/*!sc*/
body{font-family:'Poppins',-apple-system,BlinkMacSystemFont,avenir next,avenir,helvetica neue, helvetica,Ubuntu,roboto,noto,segoe ui,arial,sans-serif;color:#37292C;background-attachment:fixed;background-color:#d9e4f5;background-image:linear-gradient(315deg,#d9e4f5 0%,#f5e3e6 74%);}/*!sc*/
h1,h2,h3,h4{line-height:1.125;}/*!sc*/
h1,h2,h3{font-weight:700;}/*!sc*/
h1{font-size:var(--size-800);}/*!sc*/
h2{font-size:var(--size-700);}/*!sc*/
h3{font-size:var(--size-600);}/*!sc*/
p{font-size:var(--size-400);}/*!sc*/
::selection{background:rgba(255,255,255,0.9);}/*!sc*/
p,li{max-width:none;}/*!sc*/
.gatsby-resp-image-wrapper{margin-left:0 !important;}/*!sc*/
data-styled.g13[id="sc-global-dqoMdz1"]{content:"sc-global-dqoMdz1,"}/*!sc*/
.cKBEjL{min-height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}/*!sc*/
.cKBEjL main{margin-top:auto;margin-bottom:auto;}/*!sc*/
.cKBEjL footer{margin-top:auto;}/*!sc*/
data-styled.g14[id="layout__LayoutWrapper-qrswv8-0"]{content:"cKBEjL,"}/*!sc*/
.gGPpxa{margin-right:0.6rem;margin-bottom:0.6rem;text-transform:uppercase;font-size:var(--size-300);}/*!sc*/
.gGPpxa a{position:relative;z-index:2;background-color:rgba(255,255,255,0.7);-webkit-text-decoration:none;text-decoration:none;color:inherit;padding:0.2rem 0.6rem;border:1px solid rgba(255,255,255,1);border-radius:4px;}/*!sc*/
.gGPpxa a:hover{background-color:rgba(255,255,255,0.9);}/*!sc*/
data-styled.g16[id="tags__Tag-sc-16itk8x-0"]{content:"gGPpxa,"}/*!sc*/
.jLVknC{padding-top:var(--size-900);padding-bottom:var(--size-900);margin-left:auto;margin-right:auto;max-width:70ch;word-wrap:break-word;}/*!sc*/
data-styled.g39[id="post-template__PostWrapper-afk1br-0"]{content:"jLVknC,"}/*!sc*/
.jvERbU{font-size:var(--size-700);}/*!sc*/
data-styled.g40[id="post-template__PostTitle-afk1br-1"]{content:"jvERbU,"}/*!sc*/
.ijlCjX{font-size:var(--size-400);padding-top:1rem;text-transform:uppercase;}/*!sc*/
data-styled.g41[id="post-template__PostDate-afk1br-2"]{content:"ijlCjX,"}/*!sc*/
.dEfyJD{padding-top:var(--size-800);}/*!sc*/
.dEfyJD > * + *{margin-top:var(--size-300);}/*!sc*/
.dEfyJD > p + p{margin-top:var(--size-700);}/*!sc*/
.dEfyJD * + h1,.dEfyJD * + h2,.dEfyJD * + h3{margin-top:var(--size-900);}/*!sc*/
.dEfyJD h1{font-size:var(--size-700);}/*!sc*/
.dEfyJD h2{font-size:var(--size-600);}/*!sc*/
.dEfyJD h3{font-size:var(--size-500);}/*!sc*/
.dEfyJD b,.dEfyJD strong{font-weight:600;}/*!sc*/
.dEfyJD a{color:inherit;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration-thickness:0.125rem;text-decoration-thickness:0.125rem;}/*!sc*/
.dEfyJD blockquote{padding-left:var(--size-400);border-left:5px solid;font-style:italic;}/*!sc*/
.dEfyJD code{font-family:"Source Sans Pro",monospace;overflow-x:auto;white-space:pre-wrap;}/*!sc*/
.dEfyJD pre{overflow-x:auto;white-space:pre-wrap;max-width:100%;}/*!sc*/
data-styled.g42[id="post-template__PostContent-afk1br-3"]{content:"dEfyJD,"}/*!sc*/
.ijTjwt{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:var(--size-900);}/*!sc*/
.ijTjwt > *{position:relative;-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:1rem;padding-top:0.5rem;padding-bottom:0.5rem;border-radius:8px;border:1px solid rgba(255,255,255,0.5);background-color:rgba(255,255,255,0.3);-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);margin:0.5rem;}/*!sc*/
.ijTjwt > *:hover{background-color:rgba(255,255,255,0.5);}/*!sc*/
.ijTjwt span{text-transform:uppercase;opacity:0.6;font-size:var(--size-400);padding-bottom:var(--size-500);}/*!sc*/
.ijTjwt a{color:inherit;-webkit-text-decoration:none;text-decoration:none;font-size:var(--size-400);text-transform:capitalize;}/*!sc*/
.ijTjwt a::after{content:"";position:absolute;left:0;right:0;top:0;bottom:0;}/*!sc*/
data-styled.g43[id="post-template__PostPagination-afk1br-4"]{content:"ijTjwt,"}/*!sc*/
</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{all:inherit;bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro|Poppins:400,400i,700&amp;display=swap" rel="stylesheet"/><link rel="icon" href="/favicon-32x32.png?v=a9c34c9cfad998e9d71d69da79e233c6" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a9c34c9cfad998e9d71d69da79e233c6"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a9c34c9cfad998e9d71d69da79e233c6"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a9c34c9cfad998e9d71d69da79e233c6"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a9c34c9cfad998e9d71d69da79e233c6"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a9c34c9cfad998e9d71d69da79e233c6"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a9c34c9cfad998e9d71d69da79e233c6"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a9c34c9cfad998e9d71d69da79e233c6"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a9c34c9cfad998e9d71d69da79e233c6"/><title>ZK-Rollup 开发经验分享 Part I - FluiDex</title><meta name="description" content="致谢：感谢 barryWhiteHat、Jordi Baylina、Koh Wei Jie 给我们提供的宝贵意见！（名字按字母序排序） 对读者的期待：需要有基础的编程知识和区块链知识，可以没有任何密码学背景。 很多用户期待区块链能进一步扩容，提升性能，降低使用成本。本文将谈到的 ZK-Rollup…"/><meta property="og:title" content="ZK-Rollup 开发经验分享 Part I"/><meta property="og:description" content="致谢：感谢 barryWhiteHat、Jordi Baylina、Koh Wei Jie 给我们提供的宝贵意见！（名字按字母序排序） 对读者的期待：需要有基础的编程知识和区块链知识，可以没有任何密码学背景。 很多用户期待区块链能进一步扩容，提升性能，降低使用成本。本文将谈到的 ZK-Rollup…"/><meta property="og:type" content="website"/><meta property="og:image" content="https://raw.githubusercontent.com/Fluidex/fluidex.github.io/master/static/media/square.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="fluid_dex"/><meta name="twitter:title" content="ZK-Rollup 开发经验分享 Part I"/><meta name="twitter:description" content="致谢：感谢 barryWhiteHat、Jordi Baylina、Koh Wei Jie 给我们提供的宝贵意见！（名字按字母序排序） 对读者的期待：需要有基础的编程知识和区块链知识，可以没有任何密码学背景。 很多用户期待区块链能进一步扩容，提升性能，降低使用成本。本文将谈到的 ZK-Rollup…"/><meta name="twitter:image" content="https://raw.githubusercontent.com/Fluidex/fluidex.github.io/master/static/media/wide.png"/><link as="script" rel="preload" href="/webpack-runtime-a6a05c14793d7c0627b7.js"/><link as="script" rel="preload" href="/framework-6eebe74f6e3ca2e4baa9.js"/><link as="script" rel="preload" href="/app-3431fe19f27e9d588cd9.js"/><link as="script" rel="preload" href="/commons-5ee680bf8998dc89a339.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-js-a76bda2642029ae4f2bc.js"/><link as="fetch" rel="preload" href="/page-data/zh/blog/zkrollup-intro1/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2555585279.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2841359383.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3159585216.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout__LayoutWrapper-qrswv8-0 cKBEjL"><header class="header__StyledHeader-sc-1344zpp-0 hUaVNz"><div class="container__Container-g6pcgm-0 header__HeaderWrapper-sc-1344zpp-1 dWGLst kTLBWK"><div class="header__HeaderTitle-sc-1344zpp-2 ljBqLG"><a href="/zh/index">FluiDex</a></div><nav class="header__StyledNav-sc-1344zpp-3 gMMtgi"><ul class="header__StyledNavList-sc-1344zpp-4 lcjsVP"><li class="header__StyledNavListItem-sc-1344zpp-5 estiEP"><a href="/zh/blog">博客</a></li><li class="header__StyledNavListItem-sc-1344zpp-5 estiEP"><a href="/zh/about">关于我们</a></li><li class="header__StyledNavListItem-sc-1344zpp-5 estiEP"><a href="/zh/contact">联系我们</a></li><li class="header__StyledNavListItem-sc-1344zpp-5 estiEP"><style data-emotion="css 2b097c-container">.css-2b097c-container{position:relative;box-sizing:border-box;}</style><div class=" css-2b097c-container"><style data-emotion="css 7pg0cj-a11yText">.css-7pg0cj-a11yText{z-index:9999;border:0;clip:rect(1px, 1px, 1px, 1px);height:1px;width:1px;position:absolute;overflow:hidden;padding:0;white-space:nowrap;}</style><span aria-live="polite" aria-atomic="false" aria-relevant="additions text" class="css-7pg0cj-a11yText"></span><style data-emotion="css ib73kg-control">.css-ib73kg-control{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:hsl(0, 0%, 100%);border-color:hsl(0, 0%, 80%);border-radius:4px;border-style:solid;border-width:1px;cursor:default;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;min-height:38px;outline:0!important;position:relative;-webkit-transition:all 100ms;transition:all 100ms;box-sizing:border-box;height:35px;width:150px;}.css-ib73kg-control:hover{border-color:hsl(0, 0%, 70%);}</style><div class=" css-ib73kg-control"><style data-emotion="css 1hwfws3">.css-1hwfws3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;padding:2px 8px;-webkit-overflow-scrolling:touch;position:relative;overflow:hidden;box-sizing:border-box;}</style><div class=" css-1hwfws3"><style data-emotion="css 1uccc91-singleValue">.css-1uccc91-singleValue{color:hsl(0, 0%, 20%);margin-left:2px;margin-right:2px;max-width:calc(100% - 8px);overflow:hidden;position:absolute;text-overflow:ellipsis;white-space:nowrap;top:50%;-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);box-sizing:border-box;}</style><div class=" css-1uccc91-singleValue"><div style="display:flex">简体中文</div></div><style data-emotion="css 1g6gooi">.css-1g6gooi{margin:2px;padding-bottom:2px;padding-top:2px;visibility:visible;color:hsl(0, 0%, 20%);box-sizing:border-box;}</style><div class="css-1g6gooi"><div class="" style="display:inline-block"><input type="text" autoCapitalize="none" autoComplete="off" autoCorrect="off" id="react-select-6-input" spellcheck="false" tabindex="0" value="" aria-autocomplete="list" style="box-sizing:content-box;width:1px;label:input;background:0;border:0;font-size:inherit;opacity:1;outline:0;padding:0;color:inherit"/><div style="position:absolute;top:0;left:0;visibility:hidden;height:0;overflow:scroll;white-space:pre"></div></div></div></div><style data-emotion="css 1wy0on6">.css-1wy0on6{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-align-self:stretch;-ms-flex-item-align:stretch;align-self:stretch;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;box-sizing:border-box;}</style><div class=" css-1wy0on6"><style data-emotion="css 1okebmr-indicatorSeparator">.css-1okebmr-indicatorSeparator{-webkit-align-self:stretch;-ms-flex-item-align:stretch;align-self:stretch;background-color:hsl(0, 0%, 80%);margin-bottom:8px;margin-top:8px;width:1px;box-sizing:border-box;}</style><span class=" css-1okebmr-indicatorSeparator"></span><style data-emotion="css tlfecz-indicatorContainer">.css-tlfecz-indicatorContainer{color:hsl(0, 0%, 80%);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:8px;-webkit-transition:color 150ms;transition:color 150ms;box-sizing:border-box;}.css-tlfecz-indicatorContainer:hover{color:hsl(0, 0%, 60%);}</style><div class=" css-tlfecz-indicatorContainer" aria-hidden="true"><style data-emotion="css 8mmkcg">.css-8mmkcg{display:inline-block;fill:currentColor;line-height:1;stroke:currentColor;stroke-width:0;}</style><svg height="20" width="20" viewBox="0 0 20 20" aria-hidden="true" focusable="false" class="css-8mmkcg"><path d="M4.516 7.548c0.436-0.446 1.043-0.481 1.576 0l3.908 3.747 3.908-3.747c0.533-0.481 1.141-0.446 1.574 0 0.436 0.445 0.408 1.197 0 1.615-0.406 0.418-4.695 4.502-4.695 4.502-0.217 0.223-0.502 0.335-0.787 0.335s-0.57-0.112-0.789-0.335c0 0-4.287-4.084-4.695-4.502s-0.436-1.17 0-1.615z"></path></svg></div></div></div></div></li></ul></nav></div></header><main><div class="container__Container-g6pcgm-0 dWGLst"><div class="post-template__PostWrapper-afk1br-0 jLVknC"><article><h1 class="post-template__PostTitle-afk1br-1 jvERbU">ZK-Rollup 开发经验分享 Part I</h1><span class="post-template__PostDate-afk1br-2 ijlCjX">2021/5/12</span><section class="post-template__PostContent-afk1br-3 dEfyJD"><p><em>致谢：感谢 barryWhiteHat、Jordi Baylina、Koh Wei Jie 给我们提供的宝贵意见！（名字按字母序排序）</em></p>
<p>对读者的期待：需要有基础的编程知识和区块链知识，可以没有任何密码学背景。</p>
<p>很多用户期待区块链能进一步扩容，提升性能，降低使用成本。本文将谈到的 ZK-Rollup 是 <a href="https://ethereum.org/nl/developers/docs/layer-2-scaling/">以太坊 Layer 2 扩容方案</a> 中的一种，它精巧地使用零知识证明(ZK-SNARK)这种密码学技术来完成链上计算资源消耗的压缩，从而能够极大地(~10x-100x)提升 Ethereum 的性能。包括 Ethereum 创始人 Vitalik 在内的很多人 认为 ZK-Rollup 是长期来看最重要的 Layer 2 扩容方案。</p>
<blockquote>
<p>In general, my own view is that in the short term, optimistic rollups are likely to win out for general-purpose EVM computation and ZK rollups are likely to win out for simple payments, exchange and other application-specific use cases, but in the medium to long term ZK rollups will win out in all use cases as ZK-SNARK technology improves. — Vitalik</p>
</blockquote>
<p>本文会分享一些 ZK-Rollup 开发中的经验。撰写本文的动机在于，互联网有大量高质量的资料介绍 ZK-SNARK （零知识证明）理论本身，这些文章会介绍详细的密码学细节，另一些不太偏向技术的文章则会展望 ZK-Rollup 的作用和前景。较少见有文章会深入地介绍 ZK-Rollup 到底是怎么提升性能的？一个完整的 ZK-Rollup 系统是长什么样的？ZK-Rollup 系统中有什么少被人讨论但是重要的常识经验吗？</p>
<p><a href="https://github.com/fluidex/">FluiDex 团队</a> 作为全世界少数几个在独立开发完整 ZK-Rollup 系统的团队，希望能够分享一些自己在开发 ZK-Rollup 系统中的经验，能够反哺业界的其他参与者。我们想分享一些重要但是很少被谈到的话题，比如 ZK-Rollup 系统的性能瓶颈在哪里，它的成本又是如何构成的等。</p>
<h2>ZK-SNARK&#x26; ZK-Rollup 概述</h2>
<p>本文重点不会在于零知识证明（ZK-SNARK） 的理论本身，因为这个话题你可以在互联网上搜到足够多高质量的资料，在此不多重复。本章节会简要介绍：ZK-SNARK 能做什么？它何以能够成为 ZK-Rollup 的核心部分，和 “rollup” 一起协助以太坊提升性能？rollup 又是什么意思？</p>
<h3>ZK-SNARK 本质是什么？</h3>
<p>在区块链系统中，一般而言每个节点会做完全相同的计算，每个节点都会执行区块中每个交易，并且验证它自己的执行结果和其他节点的执行结果完全相同。换言之，每个链上交易，都会被区块链的每一个参与节点执行一遍，这是为什么区块链系统性能较低的一个重要原因。</p>
<p>只有重新计算一遍才能验证交易吗？换言之，验证的计算量一定得等于计算吗？</p>
<p>不是的，验证可以比计算容易。举个例子，对于数独游戏而言，解数独的复杂性和验证数独游戏解的复杂性是完全不同的。“把计算重做一遍”是最差的验证方式。如果读者有计算机科学的背景，你可以回忆计算复杂度中 P vs NP 的问题。</p>
<p>所以，在区块链中，如果有一种技术，能够降低验证的代价，即使增加了计算的代价，也是值得的。因为计算只发生一次，而验证会发生在每个节点上。<strong>ZK-SNARK 的本质正是这样一种压缩验证计算量的技术</strong>，通常 ZK-SNARK 能够使得验证交易的计算量比执行交易少几个数量级，准确地说，是把验证的复杂度从线性变成常数(或对数)。</p>
<p>对于一段特定的程序，ZK-SNARK 首先对这段程序做预处理，一次预处理完成之后，对于每份输入(input)，都首先计算输入的执行结果，再花费较大的计算资源生成一份 proof ( proof 实际上是很多大数 )。任何验证者，可以通过这份 proof 和本次执行使用的 input，快速验证执行的结果是正确的。</p>
<p>更加精细的伪代码描述：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// here is the the application code</span>
<span class="token comment">// it is usually called 'circuit code'</span>
<span class="token keyword">function</span> <span class="token function">some_function</span><span class="token punctuation">(</span><span class="token parameter">inputs</span><span class="token punctuation">)</span><span class="token operator">:</span>
   <span class="token comment">// no global vars allowed here</span>
   outputs <span class="token operator">=</span> <span class="token function">some_calculation</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
   <span class="token keyword">return</span> outputs


<span class="token comment">// preprocessing only runs once for every 'some_function'</span>
<span class="token comment">// we deliberately ignore 'setup' here to make it easier for understanding</span>
<span class="token comment">// for a more precise and detailed description, you can have a look at the references at the end of this article</span>
<span class="token keyword">const</span> preprocess_result <span class="token operator">=</span> <span class="token function">zksnark_preprocess</span><span class="token punctuation">(</span>some_function<span class="token punctuation">)</span>
<span class="token keyword">const</span> verification_key <span class="token operator">=</span> preprocess_result<span class="token punctuation">.</span>verification_key<span class="token punctuation">;</span>
<span class="token keyword">const</span> proving_key <span class="token operator">=</span> preprocess_result<span class="token punctuation">.</span>proving_key<span class="token punctuation">;</span>

<span class="token comment">// for every 'inputs', generate 'proof'. The following codes run off chain</span>
<span class="token comment">// we deliberately ignore 'witness' here to make it easier for understanding</span>
<span class="token comment">// we will make more explanation on what consists of inputs/outputs of a realworld ZK-Rollup system in the following sections</span>
<span class="token keyword">const</span> outputs <span class="token operator">=</span> <span class="token function">some_function</span><span class="token punctuation">(</span><span class="token parameter">inputs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// the 'prove' will need a lot of computing resource to finish</span>
<span class="token keyword">const</span> proof <span class="token operator">=</span> <span class="token function">zksnark_prove</span><span class="token punctuation">(</span>proving_key<span class="token punctuation">,</span> input<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// verify the input/output is correct</span>
<span class="token comment">// The following codes usually run on chain</span>
<span class="token keyword">const</span> is_correct <span class="token operator">=</span> <span class="token function">zksnark_verify</span><span class="token punctuation">(</span>verification_key<span class="token punctuation">,</span> input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> proof<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>is_correct <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3>真实世界 Rollup 系统的设计</h3>
<p>在一般 Rollup 系统的设计中，我们会维护一颗全局的 merkle tree。Rollup 系统中的所有状态（一般至少包括每个账户每种 token 的余额，账户的 nonce 等）都会成为这棵树中的一个叶子结点。</p>
<p>zksnark 会在数学上保证，每次对于 merkle tree 的更新都满足“预定规则”。这些“预定规则”是由 ZK-Rollup 的开发者的代码决定的。例如，对于一个 ZK-Rollup 转账系统，开发者可以在代码中要求，1. 转账金额小于转账发起账户的余额 2. 转账发起账户签名有效且 nonce 正确 3. 转账发起账户减少的金额等于转账接收账户增加的金额 ，此外，根结点的hash会从新的叶子结点重新计算出来。</p>
<p>为了保证最坏情况下的安全性（即 ZK-Rollup 的运营者在跑路之后，用户的资金能不受损失地提出来），一般要求用户能够重建整棵树(这叫 data availability) ，能够证明 “张三确实有 3 个 ETH 在这颗树中”（通过 merkle proof 等手段）。这要求系统处理的每一笔交易的数据都是完整公开的，存在区块链上。</p>
<p>我们通常对于数百甚至数千笔交易，按照指定顺序在这颗 merkle tree 上执行完成后，使用 ZK-SNARK 证明执行的结果（即新 merkle tree 的 root）是正确的。这数百或数千是一个预先决定的配置，而不能被动态更改。这批交易会被统一地证明和验证，它们被称为一个 “L2 Block”。</p>
<p>我们来使用伪代码解释，一个真实世界 ZK-Rollup 系统中的数据流形态：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// the following code runs as smart contract</span>
<span class="token comment">// 'global_merkle_tree_root' is the only state needed to be stored inside smart contract</span>
<span class="token keyword">let</span> global_merkle_tree_root <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> verification_key <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// set global_merkle_tree_root and verification_key</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">verify_txs</span><span class="token punctuation">(</span><span class="token parameter">proof<span class="token punctuation">,</span> txs<span class="token punctuation">,</span> old_merkle_root<span class="token punctuation">,</span> new_merkle_root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">assert</span><span class="token punctuation">(</span>old_merkle_root <span class="token operator">==</span> global_merkle_tree_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// in fact we will hash of txs/old_merkle_root/new_merkle_root as a single input to 'zksnark_verify' for performance. We will not discuss this detail here as it does not block understanding</span>
   <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">zksnark_verify</span><span class="token punctuation">(</span>proof<span class="token punctuation">,</span> txs<span class="token punctuation">,</span> old_merkle_root<span class="token punctuation">,</span> new_merkle_root<span class="token punctuation">)</span><span class="token punctuation">;</span>
   global_merkle_tree_root <span class="token operator">=</span> new_merkle_root<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>可以看到，合约自身除 merkle root 外，并不储存任何状态。每次状态更新都需要链下模块来准备完整的交易输入和 proof。熟悉 Stateless Ethereum 的读者会意识到 Stateless Ethereum 和 ZK-Rollup 这两者的本质是非常相似的。</p>
<!---
这里要不要解释下 witness / merkle proof 这些东西？
-->
<h2>ZK-Rollup 系统架构</h2>
<p>ZK-Rollup 系统至少需要以下几个组件：</p>
<ol>
<li>链上智能合约：负责验证 Merkle tree 的每次状态更新都是有效的，维护正确的 merkle tree root；在 Rollup 系统完全停机时，能够保证用户可以直接调用合约提取自己应有的资产；协调 L1 和 L2，保证用户向合约的充值能被及时处理并被更新在 Merkle tree 中。</li>
<li>Prover Cluster：对每个 L2 Block 做大量密码学计算获得 zksnark proof。通常需要一个大规模集群，会占用了系统中超过 99% 的计算资源。</li>
<li>State Manager：维护完整的 merkle tree。对于每个 tx，更新 merkle tree 并且为 prover cluster 提供必要的数据（如 merkle proof）。</li>
<li>其他业务模块：如 L2 浏览器；此外，不同的具体 Rollup 系统还会有自己专门的业务模块，如 FluiDex 会有一个<a href="https://github.com/fluidex/dingir-exchange">订单簿撮合引擎</a>，从用户的委托订单生成匹配的交易，发送给 State Manager。</li>
</ol>
<h2>ZK-Rollup 的 TPS 能力上限</h2>
<p>一个 ZK-Rollup 系统的 TPS 能力上限被什么制约？</p>
<h3>证明速度</h3>
<p>证明是 ZK-Rollup 系统中最消耗计算资源的部分。刚刚接触 ZK-Rollup 的人常常会误认为证明速度限制了 TPS 的上限。实际上每个 L2 Block 的证明是可以完全并行的，使用几百台服务器来搭建证明集群是 common practice。zksnark 证明耗时长，会使得从 L2 向 L1 提现完成需要的时间更久，会给运营方造成更高的服务器成本，但不会限制 TPS。</p>
<h3>数据上链和 ETH GAS 限制</h3>
<p>这是一个真正限制 ZK-Rollup TPS 的因素。我们回顾刚才介绍的 ZK-Rollup 整体设计，可以看到为了安全性/data availability，每笔 layer 2 的交易都要有数据会上链。这部分数据会作为 CALLDATA 存入 ETH 的交易历史中，平均价格可以按照 16gas/byte (EIP-2028: <a href="https://eips.ethereum.org/EIPS/eip-2028">[1]</a>, <a href="https://blog.iden3.io/istanbul-zkrollup-ethereum-throughput-limits-analysis.html">[2]</a>) 来估计。对于一般的转账&#x26;撮合等交易，每笔交易可以按照 40 bytes 来估计（<a href="https://vitalik.ca/general/2021/01/05/rollup.html">[1]</a>, <a href="https://github.com/Loopring/protocols/blob/master/packages/loopring_v3/DESIGN.md#data-availability">[2]</a>）。</p>
<p>每个 ETH 块大约需要 13s，最高允许 gas 为 12.5 Million。按照单次 Groth16/Plonk zksnark verify 成本为 0.3-0.5 Million gas 推算 (<a href="https://github.com/matter-labs/awesome-zero-knowledge-proofs">[1]</a>, <a href="https://medium.com/matter-labs/zksync-v1-1-reddit-edition-recursion-up-to-3-000-tps-subscriptions-and-more-fea668b5b0ff">[2]</a>, <a href="https://blog.kyber.network/research-trade-offs-in-rollup-solutions-a1084d2b444">[3]</a>, <a href="https://zksync.io/">[4]</a>, <a href="https://ethresear.ch/t/on-chain-scaling-to-potentially-500-tx-sec-through-mass-tx-validation/3477">[5]</a>, <a href="https://ethresear.ch/t/roll-up-roll-back-snark-side-chain-17000-tps/3675/12">[6]</a>)，单个 ETH block 内能容纳的 tx 数量上限为 12,000,000 / (40*16) ~= 20000。因此按照链上 gas 限制估算的 ZK-Rollup TPS 上限约为 1500-2000。这也是很多 Rollup 系统在白皮书中声称的性能上限。</p>
<h3>Merkle Tree 全局状态的更新</h3>
<p>这是一个很少被讨论但是至关重要的角度，<strong>真实 ZK-Rollup 系统的性能上限实际上更被这个模块限制，而不是上面讨论的证明速度和 gas 限制</strong>。</p>
<p>容纳较多用户和资产对于 Merkle tree 的深度有一定要求。假设使用 binary dense account_balance merkle tree (如下图所示) ，我们打算容纳 1 Million 用户和 1000 种资产，则需要的 merkle tree 深度为 30。对于每笔交易，假设会导致 5-10 次 merkle proof 的验证，则总计约需要 200 次 hash。ZK-Rollup Merkle tree 中的 hash 出于 zksnark 证明性能考虑，不会使用 sha3 等普通 hash，而会使用 poseidon / rescue 等适用于 zksnark 的 hash 方式。按照 <a href="https://github.com/fluidex/state_keeper/blob/a80c40015984886b68a295a810c64a682ba13135/src/types/merkle_tree.rs#L326">FluiDex 团队的测试结果</a>，单次 poseidon hash 按照 30us 计算（每个test的树深度为20，故每个hash操作是57ms / 100 / 20 ~= 30us），则从 Merkle tree 角度估算的 ZK-Rollup 系统性能上限为 1 / 0.00003 / 200 = 160 TPS。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/54e1727768d29bc1b328dc1cc1dda2fc/94829/account-merkle-tree.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 85.44303797468356%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAABiklEQVQ4y5WSV6rDQAxFZ/9rCok3EBLyk0ac3nvv1uMIZMZ5dopgGDNGV7fIyYeKoihxU8vlUmq1mtTrdalUKnK5XOJ/Tr4oA7vdbnI4HKTf70uz2ZThcCitVksGg4Hsdju5Xq/vAQHywWBG43g8lul0qu+r1UqB9/u9NBqNzwx9qYvFQmazmYLO53N9W6/Xst1uFTAMw/+APiu7z+eznE4nlQrg/X5P/H88HrGP7htmm81Ger2egnU6HZWZ1ePeJWqT8YiDZPzjRirAsPX7XBqYfbMWpVJJisWiMvOLlHmbTCaasvW4LJlMJrVyuSzValUZPp/PhA2EQyCwTTD0WSEHKSSGPEuy3W5rsqyOhYIlNsQw3KtvJAkQzaPRSN8IgzfACIedpADjGFiCoV800uQPg80rozSrYobIYNdgYJ6kDcsKMA7FPvANk7nxEXC/6fVkDXPmA55hfLfb1UCOx+PH5rRyMAKMnWIFaCQMpNtq/ARYKBQkn89LEASaJsUy53I5PSywJfpN/QENgim6OEM80QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="account merkle tree"
        title="account merkle tree"
        src="/static/54e1727768d29bc1b328dc1cc1dda2fc/f058b/account-merkle-tree.png"
        srcset="/static/54e1727768d29bc1b328dc1cc1dda2fc/c26ae/account-merkle-tree.png 158w,
/static/54e1727768d29bc1b328dc1cc1dda2fc/6bdcf/account-merkle-tree.png 315w,
/static/54e1727768d29bc1b328dc1cc1dda2fc/f058b/account-merkle-tree.png 630w,
/static/54e1727768d29bc1b328dc1cc1dda2fc/94829/account-merkle-tree.png 878w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p>
<p>因此，必须实现 merkle tree 的 <a href="https://github.com/fluidex/state_keeper/blob/a255043cbe7c899c6a8d9cc46b170a40f20623c9/src/types/merkle_tree.rs#L127">并行更新</a>， ZK-Rollup 的 TPS 才会突破 100-300 这个层次。和 zksnark proving 可以完美分布式多机多核并行不同，使用并行加速 merkle tree 的更新需要较精细的代码控制，而且非常难以实现多机分布式加速。这也是个工程上的挑战。</p>
<p>上面推算的 100-300 TPS，接近不少实际运行中的 ZK-Rollup 系统的真实性能上限。</p>
<h2>经济成本分析</h2>
<h3>ZK-Rollup 一般需要几千个 CPU cores 做 proving</h3>
<p>我仍然拿 FluiDex 的 <a href="https://github.com/fluidex/awesome-plonk">PLONK</a> <a href="https://github.com/fluidex/circuits">电路</a> 作为一个典型 ZK-Rollup 系统的例子。在我们最新的一次性能测试中，每个包含 100 个交易的 L2 Block 的单次电路证明需要在 24core 服务器上消耗约 20min。因此如果需要达到 100 TPS 的性能，需要大约 300 台 EC2 c5.12xlarge，这意味着每小时 500 USD 左右的成本。此时每个 Layer 2 tx 链下计算成本为 0.001 USD。不过目前我们做性能优化的投入还很少，预计未来有较多提升空间。</p>
<h3>链上的 gas 成本比链下服务器成本至少高两个数量级</h3>
<p>以上所说的链下计算成本，比起链上的 GAS 成本来说是九牛一毛。假设每个 Layer 2 tx 需要 40 bytes 的上链数据，ETH 价格 2000USD，GAS 价格 200GWEI，则每个 tx 需要的链上 GAS 成本约为 2.6 USD。这个成本远远高于链下 0.001 USD 的成本，但是又远远低于链上 Layer 1 复杂交易动则几十 USD 的 GAS 成本，这也是我们常常说 ZK-Rollup 能够带来至少两个数量级成本下降的数字来源。</p>
<h3>云服务中 GPU 非常没有性价比</h3>
<p>不少开发者会关心 GPU 带来的计算能力提升。在 zk snark prove 上，GPU 能带来的计算加速常在 3x-5x 这个层次。但是另一方面，由于虚拟化的不成熟，云服务商的 GPU 成本比起 CPU 成本会不成比例的昂贵，以至于出现了训练深度学习模型，<a href="https://minimaxir.com/2017/07/cpu-or-gpu/">CPU 比起 GPU 更便宜的奇观</a>。因此，如果不是自建数据中心而是使用云服务，那么使用 GPU 来加速零知识电路证明是边际效用不高的选择。</p>
<p>当然，以上所有的推算数据，会收系统代码效率和 ETH GAS 价格影响，但是预计可见未来内不太会出现量级偏差。</p>
<h2>其他开发经验碎片</h2>
<h3>ZK-SNARK 的逻辑描述为何被称为“电路”？</h3>
<p>对于任何有软件开发经验的人来说，如下代码中，if 分支和 else 分支只会执行一个，而不是两个都执行后选择其中一个作为结果。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">binaryOp</span><span class="token punctuation">(</span><span class="token parameter">op<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>op <span class="token operator">==</span> <span class="token string">"add"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> arg1 <span class="token operator">+</span> arg2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// assert(op == 'mul');</span>
    <span class="token keyword">return</span> arg1 <span class="token operator">*</span> arg2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>“不同代码分支下，计算量不会同时发生”对于软件开发似乎是天经地义的，但是对于数字芯片电路的硬件设计却并非如此。在硬件时序电路代码开发中，一般所有“分支”（如果这还叫“分支”的话）的逻辑都会在时序触发时全部执行，开发者需要自己从不同“分支”的计算结果中，正确地选择和维护全局状态。</p>
<p>在零知识证明系统中，代码逻辑会被转换成一些巨大（可能是几亿项）的多项式（称之为“算术化”），于是，问题就从“证明程序”转化为“证明多项式”。而多项式又会以门电路的方式被表达，以进行约束。这也是零知识证明电路被称之为“电路”的原因。因此零知识证明的代码具有和硬件电路相同的属性：所有分支的代码同时执行。这也就是“零知识证明电路”之所以被称为“电路”的原因。此外，和硬件电路类似，零知识证明电路中，没有递归和复杂循环，循环次数只能是常数（实际上最终这个循环会被作为语法糖展开，即 loop unrolling）。</p>
<p>因此在开发零知识证明电路代码时，开发者要重新思考自己在编写软件代码时养成的认知和习惯。例如，优化软件时，我们可以专注于代码最常执行的路径，而对于代码少走的分支则可以不优先处理。但是在零知识电路开发中，每一个分支都是会被执行的，因此不常执行的分支也需要投入同样的精力来优化。</p>
<!---
这里有必要说吗？

在零知识证明电路中，最重要的元素是所谓“约束”，即我们要求一个多项式的值为0。在电路中常会有不同的模块，例如充值/转账等，他们各自有不同的约束条件，https://github.com/fluidex/circuits/blob/aaa488149c293b1e847c732e93f9841d5715d141/src/lib/binary_merkle_tree.circom#L76

-->
<h3>对于 DSL 的看法</h3>
<p>零知识证明电路的开发语言有不同的选择，既可以直接使用 C++/Rust 实现的底层计算库如 <a href="https://github.com/HarryR/ethsnarks">ethsnarks</a> / <a href="https://github.com/zkcrypto/bellman">bellman</a>，也可以使用一些 DSL 如 <a href="https://github.com/Zokrates/ZoKrates">ZoKrates</a> / <a href="https://github.com/iden3/circom">Circom</a> / <a href="https://github.com/matter-labs/zinc">Zinc</a>。</p>
<p>我们最终的选择是 circom。 Circom 提供了恰到好处的抽象，一方面提升了读写代码的效率，另一方面也没有扭曲底层的真实细节。相比起来，ethsnarks 和 bellman 编写电路代码开发效率略低一点，而且代码被团队内部或者外部审计时，很多代码上的“语法噪音”会不利于代码读者的注意力集中到真正的核心逻辑上。ZoKrates 和 Zinc 提供的抽象层次又太高，例如 ZoKrates 中的类似 python 的控制流语法，掩盖了底层电路的本质，也不利于做一些深入底层的优化（好比 C/Rust 中内嵌汇编）。</p>
<p>如果用传统开发来类比，ethsnarks / bellman 更像是汇编，circom 是 C 语言，ZoKrates 是 Python。但是 ZoKrates 的工具链又没有真的成熟到 Python 解释器的程度，因此我们宁愿用 C 来作为唯一的开发语言，也不想自己同时维护 Python 代码和 CPython 解释器代码。</p>
<p>不过，Circom 本质上还是一种 R1CS 的 DSL，但是 FluiDex 实际使用了 PLONK proof system，因此我们有可能未来会对 Circom 做较大的改动，来更好的支持 PLONK 的 custom gate / plookup / aggregation &#x26; recursion 等特性。</p>
<h3>处理充提的复杂性</h3>
<p>处理充提要格外小心，因为这涉及了用户在以太坊主网上真实资金的改变。如果没处理好，用户/交易所则会蒙受真实资金的损失。</p>
<p>要考虑的东西很多，比如区块可能发生回滚，不同的请求可能需要不同的处理优先级，合约的升级，等等。</p>
<p>下面这个表列了一些需要考虑的情况（但不局限于以下这几条）：</p>
<ul>
<li>如果一个 block 已经 commit 但是没有及时被 verify，那么应该将状态回滚到之前的状态。</li>
<li>
<p>如果 rollup 一直不能 commit L2 blocks 或者提交对 L2 blocks 的 proof，又或者高优先的 (L1) 请求迟迟得不到处理，那么 rollup 应该被停机，并允许用户提走自己的资产。</p>
<!-- + 对于充值交易，如果充值一直得不到处理，应该允许用户在一段时间后提走自己的这笔充值。 -->
</li>
<li>路印中也描述了一种 <a href="https://github.com/Loopring/protocols/blob/master/packages/loopring_v3/DESIGN.md#withdrawal-fee-griefing">Withdrawal Fee Griefing Attack</a> 以及应对的方法。</li>
</ul>
<p>Hermez 中为了防止因为逻辑考虑不完善而导致资金被盗，设计了 <em>WithdrawalDelayer</em>，辅以对资金异常情况的监控，以便进行对提现的管理。</p>
<h2>更多阅读材料</h2>
<h3>技术文章</h3>
<ul>
<li><a href="https://vitalik.ca/general/2021/01/05/rollup.html">vitalik blog on rollup</a></li>
<li><a href="https://vitalik.ca/general/2021/01/26/snarks.html">vitalik blog on ZK-SNARK</a></li>
<li><a href="https://www.yuque.com/u428635/scg32w/edmn74">深入浅出零知识证明之 ZK-SNARKs</a></li>
<li><a href="https://docs.ethhub.io/ethereum-roadmap/ethereum-2.0/stateless-clients/">Stateless Ethereum</a></li>
</ul>
<h3>项目代码</h3>
<p>已经上线的 ZK-Rollup 项目：</p>
<ul>
<li><a href="https://github.com/matter-labs/zksync">zksync</a>: 最完整的 ZK-Rollup 开源项目代码，涵盖了一个 ZK-Rollup 系统需要的每个组件。使用 PLONK 机制，电路代码使用 bellman，链下代码使用 Rust。</li>
<li><a href="https://github.com/hermeznetwork/">hermez</a>: 和 zksync 类似。使用 Groth16 机制，电路代码使用 circom，链下代码使用 Go。</li>
<li><a href="https://github.com/Loopring/protocols/tree/master/packages/loopring_v3">loopring</a>: 仅开源了电路代码和合约代码，没有开源 State Manager 模块。使用 Groth16 机制，电路代码使用 ethsnark，链下代码不开源。</li>
</ul>
<p>开发中的 ZK-Rollup 项目：</p>
<ul>
<li><a href="https://github.com/fluidex">fluidex</a>: 开源了电路代码，State Manager，交易所撮合引擎。 使用 PLONK 机制，电路代码使用 circom，链下代码使用 Rust。</li>
</ul>
<p>使用 zksnark 技术但是不属于 ZK-Rollup 的项目：</p>
<ul>
<li><a href="https://github.com/appliedzkp/maci/">MACI</a></li>
<li><a href="https://github.com/tornadocash">Tornado Cash</a></li>
</ul>
<h2>关于我们</h2>
<p>我们是 <a href="/zh/blog/fluidex-a-zkrollup-layer2-dex/">“FluiDex: 基于 ZK-Rollup 的专业去中心化交易所”</a> 的开发团队。</p></section></article><nav class="post-template__PostPagination-afk1br-4 ijTjwt"><div><span>previous</span><a href="/zh/blog/damm/"> <!-- -->Differential AMM: 一种基于微观指标设计的灵活 AMM 算法</a></div><div><span>next</span><a href="/zh/blog/the-motivation-of-snarkit/"> <!-- -->WASM 在用于 cryptogrphy 时的限制 -- 兼谈我们为什么想开发 snarkit</a></div></nav><div><span class="tags__Tag-sc-16itk8x-0 gGPpxa"><a href="/zh/tags/technical">technical</a></span></div></div></div></main><footer class="footer__StyledFooter-sc-1d6x338-0 bXLsAg"><div class="container__Container-g6pcgm-0 footer__FooterWrapper-sc-1d6x338-2 dWGLst iWYEYe"><ul class="social-links__SocialLinkList-r9vd8i-0 elPAeh"><li class="social-links__SocialLinkItem-r9vd8i-1 PkigP"><a href="https://github.com/fluidex">github</a></li><li class="social-links__SocialLinkItem-r9vd8i-1 PkigP"><a href="https://t.me/fluid_dex">telegram</a></li><li class="social-links__SocialLinkItem-r9vd8i-1 PkigP"><a href="https://twitter.com/fluid_dex">twitter</a></li><li class="social-links__SocialLinkItem-r9vd8i-1 PkigP"><a href="https://fluid-dex.medium.com/">medium</a></li></ul><p class="footer__FooterAttribution-sc-1d6x338-1 kzqyOn">版权所有 © 2021 Fluidex团队 保留所有权利</p></div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/zh/blog/zkrollup-intro1/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-09f2335fbd5439b3b0a4.js"],"app":["/app-3431fe19f27e9d588cd9.js"],"component---src-pages-404-index-en-js":["/component---src-pages-404-index-en-js-16ceaae0911b41f14c1e.js"],"component---src-pages-404-index-zh-js":["/component---src-pages-404-index-zh-js-7e6361be422b66748607.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a7e3873d2c07695ebe7f.js"],"component---src-pages-blog-index-en-js":["/component---src-pages-blog-index-en-js-be6f5fc752e3f7126a8b.js"],"component---src-pages-blog-index-zh-js":["/component---src-pages-blog-index-zh-js-ac32559f6f328ee936d9.js"],"component---src-pages-tags-index-en-js":["/component---src-pages-tags-index-en-js-18bf4f8b00e73baaa355.js"],"component---src-pages-tags-index-zh-js":["/component---src-pages-tags-index-zh-js-1c258a3d7652941f954d.js"],"component---src-templates-about-template-js":["/component---src-templates-about-template-js-ab4b7e3b7c1c79e0b1ad.js"],"component---src-templates-contact-template-js":["/component---src-templates-contact-template-js-e8fbc5656f02270afd1c.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-c767791e3b32c1b5c9d6.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-a76bda2642029ae4f2bc.js"],"component---src-templates-tags-template-js":["/component---src-templates-tags-template-js-590a4932fac61ecedc83.js"]};/*]]>*/</script><script src="/polyfill-09f2335fbd5439b3b0a4.js" nomodule=""></script><script src="/component---src-templates-post-template-js-a76bda2642029ae4f2bc.js" async=""></script><script src="/commons-5ee680bf8998dc89a339.js" async=""></script><script src="/app-3431fe19f27e9d588cd9.js" async=""></script><script src="/framework-6eebe74f6e3ca2e4baa9.js" async=""></script><script src="/webpack-runtime-a6a05c14793d7c0627b7.js" async=""></script></body></html>