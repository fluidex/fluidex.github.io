{"componentChunkName":"component---src-templates-post-template-js","path":"/en/blog/damm/","result":{"data":{"markdownRemark":{"excerpt":"TL;DR: We propose a Differential Automated Market Makers strategy improved on Constant-Function Market Makers (CFMM) strategy and its variances, by using micro…","html":"<p><strong>TL;DR:</strong> We propose a Differential Automated Market Makers strategy improved on Constant-Function Market Makers (CFMM) strategy and its variances, by using micro indicators (price, depth, price range<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>, and etc.), rather than the product of two pools’ sizes in orginal CFMMs. This gives a more intuitive way to reflect the market, and is more friendly to market making.</p>\n<p>Automatic Market-Making (AMM) strategies are usually defined by macro indicators. Macro indicators refer to indicators that describe the total amount, including the base amount (BA) and the quote amount (QA) of the trading tokens in the AMM pool. For example, the most common AMM algorithm - the Constant Product Algorithm - requires the product of BA and QA to be equal both before and after each transaction. But in fact, for a real-world trader, micro indicators are more informative for each trade decision making. Micro indicators refer to indicators that characterize market changes, or marginal effects of transactions, such as current market price and market depth. The market price describes the average deal price of a relatively small-volume transaction in the current state, and the market depth describes the largest potential trading volume within an offered price. In plain language, assume that the price of ETH is now 3450 USDT, if I want to buy as much ETH as possible at a price not exceeding 3451, the amount of ETH I could buy can be regarded as the market depth.</p>\n<p>From the orderbook perspective, both price and depth are more intuitive than macro indicators. We here try to design a better AMM algorithm based on these two micro indicators. </p>\n<h1>Mathematical Background - The relationship between macro and micro indicators</h1>\n<p>In this section, we will explain the relationship between the micro indicators (price and depth) and the base/quote amount (pool size). As we will see, the formulas of price and depth can both be derived from the base/quote amount formulas by several derivative/inverse function transformations.</p>\n<p>Assume that base amount and quote amount in AMM pool satisfy the following relationship:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">quote = f(base)</code></pre></div>\n<p>Obviously, we have quote > 0, base > 0. f is monotonically decreasing, i.e., f’ &#x3C; 0 (as in each trade in an AMM pool, a token is turned into another token; if the amount of one token increases, the other will of course decrease).</p>\n<p>By definition, price is the absolute value of the derivative of f (as f’ is negative, it’s actually the reverse value of f’):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">price = abs(f&#39;(base)) = -f&#39;(base)</code></pre></div>\n<p>Normally we require the price, -f’, to be monotonically decreasing, i.e., the smaller the base amount, the higher the price. Thus, f” > 0. In a word, a reasonable f should be: a convex downward and monotonically decreasing function defined in the first quadrant.</p>\n<p>Correspondingly, market depth is actually the derivative of base amount w.r.t. price.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">depth = f2&#39;(price)\nf2 = Inverse(f&#39;) </code></pre></div>\n<p>Where <code class=\"language-text\">Inverse</code> means inverse function.</p>\n<p>In the above formula, f2 is the inverse function of the price function, and its derivative is the function of depth w.r.t. price.</p>\n<p>That concludes the relationship between market price/depth and base/quote function.</p>\n<h1>Mathematical Background - Solving</h1>\n<p>For a creator of AMM pool, they care the most about the initial price (price0) and initial depth (depth0). From mathematic perspective, they need to give an AMM function of the form <code class=\"language-text\">quote = f(base)</code>, so that there’s a coordinate satisfying <code class=\"language-text\">price = price0</code> and <code class=\"language-text\">depth = depth0</code>.</p>\n<p>In other words, they need to solve the following equation:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Given depth0, price0,\nf is the function describing the relationship between base and quote amount, quote = f(base). Find a f that satisfies:\n\n* There&#39;s base0, such that f&#39;(base0) = price0\n* (Inverse(f&#39;))&#39;(price0) = depth0\n\nAdditionally, it&#39;s required that f &gt; 0, f&#39; &lt; 0 and f&#39;&#39; &gt; 0, that is, f is a convex downward and monotonically decreasing function defined in the first quadrant.</code></pre></div>\n<p>Actually, as the above equations has too few constraints, there are infinite number of solutions. f could be a reciprocal function, a more general hyperbolic function, an exponential function, or a power function. However in the next section, we will see that if we specify a certain form of f and limit its coefficients, we may be able to determine a unique solution.</p>\n<h3>One of the solutions - when f is a translated reciprocal function</h3>\n<p>If f is a reciprocal function in form of:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">quote = f(base) = C / (base + BASE_DELTA) - QUOTE_DELTA </code></pre></div>\n<p>Or equivalently, using multiple variables:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">vQuote = C / vBase\nvQoute = quote + QUOTE_DELTA\nvBase = base + BASE_DELTA</code></pre></div>\n<p>where <code class=\"language-text\">C</code>, <code class=\"language-text\">BASE_DELTA</code>, <code class=\"language-text\">QUOTE_DELTA</code> are positive constants.</p>\n<p>When f is in this form, the price and depth could be derived as:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">price = -f&#39;(base) = C / (vBase**2) = vQuote / vBase\ndepth = vBase**2 / (2 * vQuote)</code></pre></div>\n<p>According to the condition that at <code class=\"language-text\">price0</code>, the depth is <code class=\"language-text\">depth0</code>, it can be solved as:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">C = vBase0 * vQuote0 = 4 * price0**3 * depth0**2\nvQuote0 = 2 * price0**2 * depth0 = quote0 + QUOTE_DELTA\nvBase0 = 2 * price0 * depth0 = base0 + BASE_DELTA</code></pre></div>\n<p>So finally, the AMM function <code class=\"language-text\">quote = f(base)</code> will be:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">quote = f(base) = C / (base + BASE_DELTA) - QUOTE_DELTA,</code></pre></div>\n<p>where <code class=\"language-text\">C = 4 * price0**3 * depth0**2</code>, <code class=\"language-text\">BASE_DELTA</code> and <code class=\"language-text\">QUOTE_DELTA</code> are random constants.</p>\n<p>To conclude, we demonstrated that if specifying f as an reciprocal function, an unique solution of f could be obtained from price and depth. Although f can actually be any types of functions, for simplicity and without the loss of generality, we will use reciprocal function as our AMM function in the rest of the post.</p>\n<h1>Formula definition of Differential AMM</h1>\n<p>Synthesizing all the derivations in the previous section, we can get the complete definition of Differential AMM:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">quote = f(base) = C / (base + BASE_DELTA) - QUOTE_DELTA</code></pre></div>\n<p>Terminology:</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Meaning</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>price0</td>\n<td>initial market price</td>\n</tr>\n<tr>\n<td>depth0</td>\n<td>initial market depth</td>\n</tr>\n<tr>\n<td>lowPrice</td>\n<td>the lowest automatic market-making price, minimum is 0</td>\n</tr>\n<tr>\n<td>highPrice</td>\n<td>the highest automatic market-making price, maximum is positive inifinite</td>\n</tr>\n<tr>\n<td>quote0</td>\n<td>initial actual quote amount</td>\n</tr>\n<tr>\n<td>base0</td>\n<td>initial actual base amount</td>\n</tr>\n<tr>\n<td>QUOTE_DELTA</td>\n<td>virtual quote amount</td>\n</tr>\n<tr>\n<td>BASE_DELTA</td>\n<td>virtual base amount</td>\n</tr>\n<tr>\n<td>C</td>\n<td>constant product</td>\n</tr>\n<tr>\n<td>vQoute0</td>\n<td>initial total quote amount, including actual and virtual</td>\n</tr>\n<tr>\n<td>vBase0</td>\n<td>initial total base amount, including actual and virtual</td>\n</tr>\n</tbody>\n</table>\n<p>Relationships between the parameters:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">(1) C = 4 * price0**3 * depth0**2\n(2) lowPrice = QUOTE_DELTA**2 / C\n(3) highPrice = C / BASE_DELTA**2\n(4) price0 = vQuote0 / vBase0\n(5) depth0 = vBase**2 / (2 * vQuote)\n(6) vQoute0 = 2 * price0**2 * depth0\n(7) vBase0 = 2 * price0 * depth0\n(8) vQoute0 = quote0 + QUOTE_DELTA\n(9) vBase0 = base0 + BASE_DELTA</code></pre></div>\n<p>Note1: Among the above formulas, (4)(5) and (6)(7) are equivalent.</p>\n<p>Note2: With the same <code class=\"language-text\">price0</code> and <code class=\"language-text\">depth0</code>, the smaller <code class=\"language-text\">QUOTE_DELTA</code> and <code class=\"language-text\">BASE_DELTA</code> are, the larger <code class=\"language-text\">base0</code> and <code class=\"language-text\">quote0</code> are. That is, when providing the same market liquidity, a greater amount of fund will lead to a lower so-called “capital efficiency”, but a wider market-making price range (i.e., from <code class=\"language-text\">lowPrice</code> to <code class=\"language-text\">highPrice</code>). Extremely, when <code class=\"language-text\">QUOTE_DELTA</code> and <code class=\"language-text\">BASE_DELTA</code> are both 0, <code class=\"language-text\">lowPrice</code> will be 0 and <code class=\"language-text\">highPrice</code> will be inifinite. In this situation, DAMM degenerates into Constant Product AMM. We could adjust capital efficiency arbitrarily by adjusting <code class=\"language-text\">lowPrice</code> and <code class=\"language-text\">highPrice</code>.</p>\n<p>In reality, for the following 3 groups of parameters, (A) depth price, (B) lowPrice highPrice, (C) quote0 base0, given any two groups, the third group, as well as the complete market-making function could be derived.</p>\n<p>Here are the three scenarios corresponding to three initial conditions:</p>\n<h3>Given price and depth (A), and initial amounts (C)</h3>\n<p>That is, in the equations, given <code class=\"language-text\">price0</code>, <code class=\"language-text\">depth0</code>, and <code class=\"language-text\">quote0</code>, <code class=\"language-text\">base0</code>, we then want to calculate market-making price range and other parameters.</p>\n<p>For step-by-step solution please refer to: <a href=\"https://github.com/fluidex/differential-amm/blob/673b2801c822bc5e75dc63f1def0204b8d57bb03/main.ts#L39\">https://github.com/fluidex/differential-amm/blob/673b2801c822bc5e75dc63f1def0204b8d57bb03/main.ts#L39</a></p>\n<h3>Given price and depth (A), and market-making price range (B)</h3>\n<p>That is, in the equations, given <code class=\"language-text\">price0</code>, <code class=\"language-text\">depth0</code>, and <code class=\"language-text\">lowPrice</code> (could be 0), <code class=\"language-text\">highPrice</code> (could be inifinity), need to calculate initial amount and other parameters.</p>\n<p>For step-by-step solution please refer to: <a href=\"https://github.com/fluidex/differential-amm/blob/673b2801c822bc5e75dc63f1def0204b8d57bb03/main.ts#L53\">https://github.com/fluidex/differential-amm/blob/673b2801c822bc5e75dc63f1def0204b8d57bb03/main.ts#L53</a></p>\n<h3>Given market-making price range (B), and initial amounts (C)</h3>\n<p>This is the most complex scenario. Actually it is equivalent to solving a binary quadratic equation. By solving the equation we could get all other parameters.</p>\n<p>For step-by-step solution please refer to: <a href=\"https://github.com/fluidex/differential-amm/blob/673b2801c822bc5e75dc63f1def0204b8d57bb03/main.ts#L72\">https://github.com/fluidex/differential-amm/blob/673b2801c822bc5e75dc63f1def0204b8d57bb03/main.ts#L72</a></p>\n<p>From the above three scenarios, we could see that DAMM has great flexibility. On the one hand, different scenarios may have different requirements and different initial conditions. Under the above three initial conditions, we are still able to solve a correct DAMM strategy. On the other hand, <strong>we can abitrarily adjust capital efficiency through the price range or initial amount</strong>.</p>\n<h1>Miscellaneous</h1>\n<h2>Converting AAM to orderbook</h2>\n<p>By approximating the AMM curve section by section, we can get a discretized orderbook. In our <a href=\"https://github.com/fluidex/differential-amm/blob/673b2801c822bc5e75dc63f1def0204b8d57bb03/main.ts#L156\">reference implementation</a>, we could specify price interval and the number of orders, and get order size and average price by calculating BASE<em>DELTA and QUOTE</em>DELTA.</p>\n<h2>Mathematical equivalance</h2>\n<p>It’s easy to see that DAMM is mathematically equivalent to the market maker algorithm (x + a)(y + b) = k. The difference is that we interpret it in a micro perspective way, as well as possibilities to solve from different initial conditions.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>Although Uniswap V3 also supports providing liquidity in a price range, liquidity providers are not allowed to configure the base-quote ratio, neither can Uniswap V3 support single-side market making.</p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","frontmatter":{"title":"Differential AMM: a highly flexible AMM algorithm based on micro indicators","tags":["technical"],"date":"2021-05-19T00:00:00.000Z","description":null}},"prev":{"frontmatter":{"title":"FluiDex 2021-05 Updates"},"fields":{"slug":"/en/blog/2021-05-27-updates/"}},"next":{"frontmatter":{"title":"ZK-Rollup development experience sharing, Part I"},"fields":{"slug":"/en/blog/zkrollup-intro1/"}}},"pageContext":{"slug":"/en/blog/damm/","prevSlug":"/en/blog/2021-05-27-updates/","nextSlug":"/en/blog/zkrollup-intro1/","langKey":"en"}},"staticQueryHashes":["2555585279","2841359383","3159585216"]}